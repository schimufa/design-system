#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ” Running STRICT pre-commit validation..."
echo "This will run ALL quality checks and block commits on any failure."
echo ""

# Check if bypass flag is set
if [ "$SKIP_VALIDATION" = "true" ]; then
    echo "âš ï¸  VALIDATION BYPASSED - SKIP_VALIDATION=true"
    echo "ğŸš¨ This should only be used for emergency fixes!"
    exit 0
fi

# Format code first
echo "ğŸ“ Formatting code..."
npm run format

# Run design system contribution validation
echo "ğŸ¨ Validating design system contribution..."
cd packages/design-system

# Run the full validation suite
if ! pnpm validate-contribution; then
    echo ""
    echo "âŒ Design system contribution validation failed!"
    echo ""
    echo "ğŸ“‹ VALIDATION REPORT:"
    echo "The contribution does not meet design system standards."
    echo ""
    echo "ğŸ’¡ QUICK FIXES:"
    echo "  ğŸ”§ TypeScript errors: pnpm build"
    echo "  ğŸ§¹ Linting issues: pnpm lint --fix"
    echo "  ğŸ§ª Test failures: pnpm test"
    echo "  ğŸ“ Missing files: Add required component files"
    echo "  ğŸ“š Documentation: Update README, stories, or docs"
    echo ""
    echo "ğŸš¨ BYPASS (use with caution):"
    echo "  SKIP_VALIDATION=true git commit -m 'your message'"
    echo ""
    echo "ğŸ“– For detailed guidance, see:"
    echo "  - EXTERNAL_CONTRIBUTION_GUIDE.md"
    echo "  - CONTRIBUTION_STANDARDS_SUMMARY.md"
    echo ""
    exit 1
fi

# Go back to root
cd ../..

# Run comprehensive checks
echo "ğŸ§¹ Running linter..."
if ! pnpm lint; then
    echo ""
    echo "âŒ Linting failed!"
    echo "Run: pnpm lint --fix"
    echo ""
    exit 1
fi

echo "ğŸ”· Running type check..."
if ! pnpm typecheck; then
    echo ""
    echo "âŒ Type checking failed!"
    echo "Fix TypeScript errors before committing."
    echo ""
    exit 1
fi

echo "ğŸ§ª Running tests..."
if ! pnpm test; then
    echo ""
    echo "âŒ Tests failed!"
    echo "Fix failing tests before committing."
    echo ""
    exit 1
fi

echo "ğŸ—ï¸  Running build..."
if ! pnpm build; then
    echo ""
    echo "âŒ Build failed!"
    echo "Fix build errors before committing."
    echo ""
    exit 1
fi

echo ""
echo "âœ… ALL CHECKS PASSED!"
echo "ğŸ‰ Your contribution meets all design system standards!"
echo "ğŸš€ Ready to commit!"
echo ""
